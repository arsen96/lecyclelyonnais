name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/*
    paths-ignore:
      - '**/*.md'
      - '**/*.yaml'
      - '**/*.json'

  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - '**/*.yaml'
      - '**/*.json'

jobs:
  # ===================================
  # JOB 0: Setup Angular/Ionic Environment
  # ===================================
  setup-ionic:
    name: ğŸ“± Setup Angular/Ionic
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ CrÃ©er les fichiers environment Angular/Ionic
        run: |
          # VÃ©rifier si le dossier src/environments existe (projet Angular/Ionic)
          if [ -d "src" ]; then
            mkdir -p src/environments
            
            # Environment de dÃ©veloppement
            cat > src/environments/environment.ts << EOF
          export const environment = {
            production: false,
            GOOGLE_CLIENT_ID: '${{ secrets.GOOGLE_CLIENT_ID }}',
            GOOGLE_MAP_API: '${{ secrets.GOOGLE_MAP_API }}',
            test_authToken: '${{ secrets.TEST_AUTHTOKEN }}',
            test_userRole: 'admin',    
            test_access_token: '${{ secrets.TEST_ACCESS_TOKEN }}',
            test_clientBasicAuth: '${{ secrets.TEST_CLIENTBASICAUTH }}'   
          };
          EOF
            
            # Environment de production
            cat > src/environments/environment.prod.ts << EOF
          export const environment = {
            production: true,
            GOOGLE_CLIENT_ID: '${{ secrets.GOOGLE_CLIENT_ID }}',
            GOOGLE_MAP_API: '${{ secrets.GOOGLE_MAP_API }}',
            test_authToken: '${{ secrets.TEST_AUTHTOKEN }}',
            test_userRole: 'admin',    
            test_access_token: '${{ secrets.TEST_ACCESS_TOKEN }}',
            test_clientBasicAuth: '${{ secrets.TEST_CLIENTBASICAUTH }}'    
          };
          EOF
            
            echo "âœ… Fichiers environment Angular/Ionic crÃ©Ã©s"
          else
            echo "â„¹ï¸ Pas de projet Angular/Ionic dÃ©tectÃ©"
          fi
          
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: |
          npm ci
          # Installer Ionic CLI si ionic.config.json existe
          if [ -f "ionic.config.json" ]; then
            npm install -g @ionic/cli @angular/cli
            echo "âœ… Ionic CLI installÃ©"
          fi
          
      - name: ğŸ”¨ Build Angular/Ionic (si applicable)
        run: |
          if [ -f "ionic.config.json" ]; then
            echo "ğŸ”¨ Build de l'application Ionic..."
            ionic build --prod
          elif [ -f "angular.json" ]; then
            echo "ğŸ”¨ Build de l'application Angular..."
            ng build --prod
          else
            echo "â„¹ï¸ Pas de build Angular/Ionic nÃ©cessaire"
          fi
        continue-on-error: true
          
      - name: ğŸ“¤ Upload des artifacts Ionic/Angular
        if: hashFiles('ionic.config.json') != '' || hashFiles('angular.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: ionic-angular-build-${{ github.sha }}
          path: |
            dist/
            www/
          retention-days: 1

  # ===================================
  # JOB 1: Tests API avec Newman/Postman
  # ===================================
  test-api:
    name: ğŸ”— Tests API
    runs-on: ubuntu-latest
    needs: setup-ionic
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci
        
      - name: ğŸ”„ Sync Postman collections
        run: npm run postman:sync
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        
      - name: ğŸš€ DÃ©marrer l'application
        run: |
          npm start &
          sleep 15
        env:
          NODE_ENV: test
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          
      - name: ğŸ§ª Test - Authentification
        run: npm run test:api:auth
        continue-on-error: false
        
      - name: ğŸ§ª Test - Techniciens
        run: npm run test:api:technicians
        continue-on-error: true
        
      - name: ğŸ§ª Test - Companies
        run: npm run test:api:company
        continue-on-error: true
        
      - name: ğŸ§ª Test - Bicycles
        run: npm run test:api:bicycle
        continue-on-error: true
        
      - name: ğŸ§ª Test - Zones
        run: npm run test:api:zones
        continue-on-error: true
        
      - name: ğŸ§ª Test - Interventions
        run: npm run test:api:intervention
        continue-on-error: true
        
  # ===================================  
  # JOB 2: Tests unitaires
  # ===================================
  test-unit:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: setup-ionic
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ TÃ©lÃ©charger les artifacts Ionic/Angular
        if: hashFiles('ionic.config.json') != '' || hashFiles('angular.json') != ''
        uses: actions/download-artifact@v4
        with:
          name: ionic-angular-build-${{ github.sha }}
        continue-on-error: true
        
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci
        
      - name: ğŸ§ª Tests unitaires API
        run: npm run test:unit
        continue-on-error: true
        
      - name: ğŸ§ª Tests unitaires Angular/Ionic
        run: |
          if [ -f "karma.conf.js" ] || [ -f "src/karma.conf.js" ]; then
            echo "ğŸ§ª Lancement des tests Angular/Ionic..."
            if command -v ng &> /dev/null; then
              ng test --watch=false --browsers=ChromeHeadless
            else
              npm run test 2>/dev/null || echo "Aucun script de test Angular configurÃ©"
            fi
          else
            echo "â„¹ï¸ Pas de tests unitaires Angular/Ionic configurÃ©s"
          fi
        continue-on-error: true

  # ===================================
  # JOB 3: Tests E2E Ionic (optionnel)
  # ===================================
  test-e2e-ionic:
    name: ğŸ¯ Tests E2E Ionic
    runs-on: ubuntu-latest
    needs: setup-ionic
    if: hashFiles('ionic.config.json') != ''
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ TÃ©lÃ©charger les artifacts Ionic
        uses: actions/download-artifact@v4
        with:
          name: ionic-angular-build-${{ github.sha }}
        continue-on-error: true
        
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: |
          npm ci
          npm install -g @ionic/cli
          
      - name: ğŸ¯ Lancer les tests E2E
        run: |
          if [ -f "e2e/protractor.conf.js" ] || [ -f "cypress.json" ] || [ -f "cypress.config.js" ]; then
            echo "ğŸ¯ Tests E2E dÃ©tectÃ©s..."
            if [ -f "cypress.json" ] || [ -f "cypress.config.js" ]; then
              npx cypress run
            elif command -v ionic &> /dev/null; then
              ionic e2e
            fi
          else
            echo "â„¹ï¸ Pas de tests E2E configurÃ©s"
          fi
        continue-on-error: true

  # ===================================
  # JOB 4: RÃ©sultats et notifications
  # ===================================
  results:
    name: ğŸ“Š RÃ©sultats
    runs-on: ubuntu-latest
    needs: [setup-ionic, test-api, test-unit, test-e2e-ionic]
    if: always()  # Toujours exÃ©cuter mÃªme si les tests Ã©chouent
    
    steps:
      - name: ğŸ“Š Afficher les rÃ©sultats
        run: |
          echo "==================================="
          echo "ğŸ“Š RÃ‰SULTATS DU PIPELINE COMPLET"
          echo "==================================="
          echo "ğŸ“± Setup Ionic: ${{ needs.setup-ionic.result }}"
          echo "ğŸ”— Tests API: ${{ needs.test-api.result }}"
          echo "ğŸ§ª Tests unitaires: ${{ needs.test-unit.result }}"
          echo "ğŸ¯ Tests E2E Ionic: ${{ needs.test-e2e-ionic.result }}"
          echo "==================================="
          
          if [[ "${{ needs.setup-ionic.result }}" == "success" ]]; then
            echo "âœ… Setup Ionic: SUCCÃˆS"
          else
            echo "âŒ Setup Ionic: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.test-api.result }}" == "success" ]]; then
            echo "âœ… Tests API: SUCCÃˆS"
          else
            echo "âŒ Tests API: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.test-unit.result }}" == "success" ]]; then
            echo "âœ… Tests unitaires: SUCCÃˆS"
          else
            echo "âŒ Tests unitaires: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.test-e2e-ionic.result }}" == "success" ]]; then
            echo "âœ… Tests E2E Ionic: SUCCÃˆS"
          else
            echo "âŒ Tests E2E Ionic: Ã‰CHEC ou NON CONFIGURÃ‰"
          fi
          
      - name: ğŸš¨ Ã‰chec critique si auth Ã©choue
        if: needs.test-api.result == 'failure'
        run: |
          echo "ğŸš¨ Ã‰CHEC CRITIQUE: Les tests d'authentification ont Ã©chouÃ©!"
          echo "Le dÃ©ploiement ne peut pas continuer."
          exit 1
          
      - name: âš ï¸ Avertissement setup Ionic
        if: needs.setup-ionic.result == 'failure'
        run: |
          echo "âš ï¸ AVERTISSEMENT: Le setup Ionic a Ã©chouÃ©!"
          echo "VÃ©rifiez vos secrets GitHub pour les variables d'environnement."
          
  # ===================================
  # JOB 5: DÃ©ploiement (si tout rÃ©ussit)
  # ===================================
  # deploy:
  #   name: ğŸš€ DÃ©ploiement
  #   runs-on: ubuntu-latest
  #   needs: [setup-ionic, test-api, test-unit]
  #   if: github.ref == 'refs/heads/main' && needs.test-api.result == 'success'
    
  #   steps:
  #     - name: ğŸ“¥ RÃ©cupÃ©rer le code
  #       uses: actions/checkout@v4
        
  #     - name: ğŸ“¥ TÃ©lÃ©charger les artifacts de build
  #       if: hashFiles('ionic.config.json') != '' || hashFiles('angular.json') != ''
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: ionic-angular-build-${{ github.sha }}
  #       continue-on-error: true
          
  #     - name: ğŸš€ DÃ©ploiement automatique
  #       run: |
  #         echo "ğŸš€ PrÃªt pour le dÃ©ploiement!"
  #         echo "API: Tests passÃ©s avec succÃ¨s"
  #         if [ -d "dist" ] || [ -d "www" ]; then
  #           echo "Frontend: Build disponible"
  #         fi
  #         # Ajoutez ici vos commandes de dÃ©ploiement
  #         # Exemple:
  #         # - Firebase: npx firebase deploy --token ${{ secrets.FIREBASE_TOKEN }}
  #         # - Netlify: npx netlify-cli deploy --prod --dir dist
  #         # - Heroku: git push heroku main