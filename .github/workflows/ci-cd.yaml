name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/*
    paths-ignore:
      - '**/*.md'

  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'

jobs:
  # ==================================
  # JOB 1: Tests API Backend
  # ==================================
  test-api:
    name: ğŸ”— Tests API Backend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./back
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ./back/package-lock.json
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci
        
      - name: ğŸ”„ Sync Postman collections
        run: npm run postman:sync
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true
        
      - name: ğŸš€ DÃ©marrer l'application
        run: |
          npm start &
          sleep 15
        env:
          NODE_ENV: test
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          
      - name: ğŸ§ª Test - Authentification
        run: npm run test:api:auth
        continue-on-error: false
        
      - name: ğŸ§ª Test - Techniciens
        run: npm run test:api:technicians
        continue-on-error: true
        
      - name: ğŸ§ª Test - Companies
        run: npm run test:api:company
        continue-on-error: true
        
      - name: ğŸ§ª Test - Bicycles
        run: npm run test:api:bicycle
        continue-on-error: true
        
      - name: ğŸ§ª Test - Zones
        run: npm run test:api:zones
        continue-on-error: true
        
      - name: ğŸ§ª Test - Interventions
        run: npm run test:api:intervention
        continue-on-error: true

  # ===================================  
  # JOB 2: Tests unitaires Backend
  # ===================================
  test-unit-backend:
    name: ğŸ§ª Tests Unitaires Backend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./back
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ./back/package-lock.json
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci
        
      - name: ğŸ§ª Lancer les tests unitaires
        run: npm run test:unit
        continue-on-error: true

  # ===================================
  # JOB 3: Build et Tests Frontend
  # ===================================
  test-frontend:
    name: ğŸ¨ Frontend Build & Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./front
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ./front/package-lock.json
          
      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci
        
      - name: ğŸ§ª Tests unitaires Frontend
        run: npm run test:ci
        continue-on-error: true

  # ===================================
  # JOB 4: Tests E2E Cypress (optionnel)
  # ===================================
  test-e2e:
    name: ğŸ” Tests E2E Cypress
    runs-on: ubuntu-latest
    needs: [test-api, test-frontend]  # Attend que API et Frontend soient OK
    if: needs.test-api.result == 'success' && needs.test-frontend.result == 'success'

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      # DÃ©marrer le backend
      - name: ğŸ—ï¸ Setup Node.js pour Backend
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ./back/package-lock.json
          
      - name: ğŸ“¦ Installer dÃ©pendances Backend
        run: npm ci
        working-directory: ./back
        
      - name: ğŸš€ DÃ©marrer Backend
        run: |
          npm start &
          sleep 15
        working-directory: ./back
        env:
          NODE_ENV: test
          PORT: 3000
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        
      # DÃ©marrer le frontend  
      - name: ğŸ“¦ Installer dÃ©pendances Frontend
        run: npm ci
        working-directory: ./front
        
      - name: ğŸ¨ DÃ©marrer Frontend
        run: |
          npm start &
          sleep 30
        working-directory: ./front
        
      # Tests Cypress
      - name: ğŸ” Tests Cypress E2E
        run: npm run cypress:run
        working-directory: ./front
        continue-on-error: true

  # ===================================
  # JOB 5: RÃ©sultats
  # ===================================
  results:
    name: ğŸ“Š RÃ©sultats
    runs-on: ubuntu-latest
    needs: [test-api, test-unit-backend, test-frontend, test-e2e]
    if: always()
    
    steps:
      - name: ğŸ“Š Afficher les rÃ©sultats
        run: |
          echo "============================================="
          echo "ğŸ“Š RÃ‰SULTATS COMPLETS DES TESTS"
          echo "============================================="
          echo "ğŸ”— Tests API Backend: ${{ needs.test-api.result }}"
          echo "ğŸ§ª Tests unitaires Backend: ${{ needs.test-unit-backend.result }}"
          echo "ğŸ¨ Build & Tests Frontend: ${{ needs.test-frontend.result }}"
          echo "ğŸ” Tests E2E Cypress: ${{ needs.test-e2e.result }}"
          echo "============================================="
          
          # RÃ©sumÃ© final
          if [[ "${{ needs.test-api.result }}" == "success" ]] && [[ "${{ needs.test-frontend.result }}" == "success" ]]; then
            echo "ğŸ‰ BUILD PRINCIPAL: SUCCÃˆS"
            echo "âœ… L'application est prÃªte pour le dÃ©ploiement"
          else
            echo "âŒ BUILD PRINCIPAL: Ã‰CHEC"
            echo "ğŸš¨ Des problÃ¨mes critiques empÃªchent le dÃ©ploiement"
          fi